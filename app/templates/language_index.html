{% extends "base.html" %}
{% load static %}
{% load metadata_templatetags %}

{% block extra_css %}

  <!-- Include jQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  
  <!-- Include Select2 -->
  <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />

{% endblock %}



{% block page_content %}

<div class="d-flex justify-content-between">
  <div>
    <div class="page-title" style="display: inline">Languages</div>
    {% if request.user|has_group:"Archivist"%}
    <div style="display: inline"><a class="stealth" href="add"><i class="bi bi-plus fs-2"></i></a></div>
    {% endif %}
  </div>
  <div class="p-2 bg-warning text-dark rounded border border-light">
    Use EMPTY to search for empty fields
  </div>
</div>


<form method="GET" action="." class="mb-2">
  <div class="">
    <div class="row">
        <div class="col-md-1">
            <button type="submit" class="btn btn-primary" name="filter">Sort</button>
        </div>
        <div class="col-md-2">
            <select class="form-control" id="form_control_sort" name="form_control_sort">
                    <option value="name">Name</option>
                    <option value="iso">ISO</option>
                    <option value="tree">Families</option>
                    <option value="updated">Last updated</option>
            </select>
        </div>
        <div class="col-md-1">
        </div>
        <div class="col-md-2">
            <div class="btn-group batch-edit-container" role="group" aria-label="Batch edit actions">
                <button type="button" class="btn btn-primary" id="openSpreadsheetBtn" data-batch-type="languages">Batch Edit</button>
                <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                    <span class="visually-hidden">Toggle Dropdown</span>
                </button>
                <ul class="dropdown-menu" aria-labelledby="batchEditDropdown">
                    <li><a class="dropdown-item" href="#" data-batch-type="languages">Languages</a></li>

                    <li><a class="dropdown-item" href="#" data-batch-type="families">Families</a></li>
                    <li><a class="dropdown-item" href="#" data-batch-type="languoids">All Languoids</a></li>
                    <li><a class="dropdown-item" href="#" data-batch-type="new">Add New Languoids</a></li>
                </ul>
            </div>
        </div>
        <div class="col-md-1">
            <button type="submit" class="btn btn-primary" name="export">Export</button>
        </div>
    </div>
    <div class="row mt-2">
      Filtered results: {{ results_count }}
    </div>
    <div class="row">
        <div class="col-md-3">
          <div class="row">
            <div class="col-md-6">
              <div class="input-group">
                <input class="form-control py-2 border-right-0 border" type="search" name="iso_contains"
                    placeholder="ISO code contains..." value="{{ iso_contains_query_last }}" />
                <span class="input-group-text bg-transparent">
                  <i class="bi bi-search"></i>
                </span>
              </div>
            </div>
            <div class="col-md-6">
              <div class="input-group">
                <input class="form-control py-2 border-right-0 border" type="search" name="glottocode_contains"
                    placeholder="Glottocode contains..." value="{{ glottocode_contains_query_last }}" />
                <span class="input-group-text bg-transparent">
                  <i class="bi bi-search"></i>
                </span>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="input-group">
            <input class="form-control py-2 border-right-0 border" type="search" name="name_contains"
            placeholder="Name contains..." value="{{ name_contains_query_last }}" />
            <span class="input-group-text bg-transparent">
              <i class="bi bi-search"></i>
            </span>
          </div>
        </div>
        <div class="col-md-2">
          <div class="input-group">
            <input class="form-control py-2 border-right-0 border" type="search" name="family_contains"
            placeholder="Family contains..." value="{{ family_contains_query_last }}" />
            <span class="input-group-text bg-transparent">
              <i class="bi bi-search"></i>
            </span>
          </div>
        </div>
        <div class="col-md-2">
          <div class="input-group">
            <input class="form-control py-2 border-right-0 border" type="search" name="primary_subgroup_contains"
            placeholder="Primary subgroup contains..." value="{{ primary_subgroup_contains_query_last }}" />
            <span class="input-group-text bg-transparent">
              <i class="bi bi-search"></i>
            </span>
          </div>
        </div>
        <div class="col-md-2">
          <div class="input-group">
            <input class="form-control py-2 border-right-0 border" type="search" name="region_contains"
            placeholder="Region contains..." value="{{ region_contains_query_last }}" />
            <span class="input-group-text bg-transparent">
              <i class="bi bi-search"></i>
            </span>
          </div>
        </div>
        <div class="col-md-1">
          <div class="input-group">
            <select class="form-select" id="has_items" name="has_items" onkeydown="if (event.key === 'Enter') { this.form.submit(); return false; }">
              <option value="all" {% if has_items_query_last == 'all' %}selected{% endif %}>All</option>
              <option value="items" {% if has_items_query_last == 'items' %}selected{% endif %}>Has items</option>
              <option value="no_items" {% if has_items_query_last == 'no_items' %}selected{% endif %}>No items</option>
            </select>
          </div>
        </div>
    </div>
  </div>
</form>
{% for language in queryset %}
<a class="link-dark link-opacity-50-hover link-underline-opacity-0 link-underline-opacity-50-hover" href="{% url 'language_detail' language.pk %}">
    <div class="row languages-index-row">
      <div class="col-md-3">
        <div class="row">
          <div class="col-md-6">
            {{ language.iso }}
          </div>
          <div class="col-md-6">
            {{ language.glottocode }}
          </div>
        </div>
      </div>
      <div class="col-md-2">
          {{ language.name }}
      </div>
      <div class="col-md-2">
          {{ language.family }}
      </div>
      <div class="col-md-2">
          {{ language.pri_subgroup }}
      </div>
      <div class="col-md-2">
        {{ language.region }}
      </div>
      <div class="col-md-1">
        {{ language.item_count }}
      </div>
    </div>
</a>
{% endfor %}

<div class="pagination">
    <span class="step-links">
        {% if queryset.has_previous %}
            <a href="?{% url_replace page=1 %}">&laquo; first</a>
            <a href="?{% url_replace page=queryset.previous_page_number %}">previous</a>
        {% endif %}

        <span class="current">
            Page {{ queryset.number }} of {{ queryset.paginator.num_pages }}.
        </span>

        {% if queryset.has_next %}
            <a href="?{% url_replace page=queryset.next_page_number %}">next</a>
            <a href="?{% url_replace page=queryset.paginator.num_pages %}">last &raquo;</a>
        {% endif %}
    </span>
</div>

<div id="spreadsheetOverlay" class="overlay">
  <div class="overlay-content">
    <div id="react-spreadsheet-languoids"
        data-view-type="{{ view_type }}"
        {% if glottocode %}data-glottocode="{{ glottocode }}"{% endif %}>
    </div>
  </div>
</div>

<!-- Add these script tags before your bundle -->
<script src="https://unpkg.com/react@18.3.1/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.development.js" crossorigin></script>
<script src="{% static 'js/react-bundle.js' %}"></script>

<script>
$('select[name=form_control_sort]').val("{{ order_choice_last }}");
$('.form-control').form-control('refresh')
</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const batchEditElements = document.querySelectorAll('[data-batch-type]');
    const spreadsheetContainer = document.getElementById('react-spreadsheet-languoids');
    const overlay = document.getElementById('spreadsheetOverlay');
    let root = null;

    function openSpreadsheet(batchType) {
      let url = '/languages/batch/';
      if (batchType !== 'languoids') {
        url += `${batchType}/`;
      }
      window.history.pushState(null, '', url);
      openOverlay();
    }

    function closeSpreadsheet() {
      root.unmount();
      overlay.style.display = 'none';
      document.body.classList.remove('overlay-open');
      window.history.pushState(null, '', '/languages/');
      
      // Add this line to reload the underlying page data if necessary
      if (!document.querySelector('.languages-index-row')) {
        window.location.reload();
      }
    }

    function openOverlay() {
      overlay.style.display = 'block';
      document.body.classList.add('overlay-open');
      
      root = window.renderLanguoidSheet('react-spreadsheet-languoids', { 
        onClose: closeSpreadsheet
      });
    }

    batchEditElements.forEach(element => {
      element.addEventListener('click', (e) => {
        e.preventDefault();
        const batchType = e.target.dataset.batchType;
        openSpreadsheet(batchType);
      });
    });

    // Handle browser back/forward buttons
    window.addEventListener('popstate', function(event) {
      if (window.location.pathname.startsWith('/languages/batch/')) {
        openOverlay();
      } else if (window.location.pathname === '/languages/') {
        closeSpreadsheet();
      }
    });

    // Check initial URL
    if (window.location.pathname.startsWith('/languages/batch/')) {
      openOverlay();
    }
  });
</script>

{% endblock %}