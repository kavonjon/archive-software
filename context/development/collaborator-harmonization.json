{
  "collaborator_model_harmonization": {
    "version": "1.0",
    "last_updated": "2025-11-08",
    "conversation_reference": "Comprehensive Collaborator model backend/frontend harmonization, name field restructuring, and Dialect/DialectInstance decommissioning",
    
    "overview": {
      "decision_id": "collab_001",
      "content": "Major refactoring of Collaborator model to harmonize naming system, simplify language relationships, and prepare for production",
      "added_date": "2025-11-08",
      "scope": [
        "Collaborator name field restructuring and signal-based computation",
        "Full decommissioning of Dialect and DialectInstance models",
        "Language relationship simplification (direct M2M to Languoid)",
        "React frontend enhancements for CollaboratorDetail and CollaboratorList",
        "Migration from custom through models to Django's default M2M tables"
      ],
      "status": "active",
      "confidence_level": "high"
    },
    
    "name_field_restructuring": {
      "decision_id": "collab_002",
      "content": "Restructured Collaborator name fields for production-ready data integrity and consistency",
      "added_date": "2025-11-08",
      "motivation": "Data was messy with inconsistent name formats. Needed to enforce structure and enable proper sorting/searching/citation formatting",
      
      "field_architecture": {
        "component_fields": [
          "first_names (CharField) - Given names",
          "nickname (CharField) - Preferred name or nickname in quotes",
          "last_names (CharField) - Surname(s)",
          "name_suffix (CharField) - Jr., III, etc.",
          "other_names (ArrayField) - Aliases, alternative spellings"
        ],
        "computed_field": {
          "full_name": "Auto-calculated from component fields via pre_save signal",
          "format": "first_names \"nickname\" last_names name_suffix",
          "rules": [
            "Empty fields are omitted",
            "Extra spaces removed",
            "Quotes only included if nickname is present",
            "One-way sync: Staff edit components, full_name is calculated"
          ]
        },
        "read_only_in_ui": [
          "full_name is non-editable in React frontend",
          "Displayed with helper text: 'Full Name (computed from name fields below)'"
        ]
      },
      
      "signal_implementation": {
        "signal_name": "compute_collaborator_derived_fields",
        "file": "app/metadata/signals.py",
        "trigger": "pre_save on Collaborator model",
        "responsibilities": [
          "Calculate full_name from components",
          "Standardize birthdateand deathdate to YYYY/MM/DD",
          "Generate slug from full_name using base58 encoding",
          "Detect anonymous flag changes and log warnings if collaborator is referenced"
        ],
        "design_principle": "Design for the End State First - all derived fields computed in one place"
      },
      
      "display_name_variations": {
        "purpose": "Support different citation and display contexts",
        "calculated_on_frontend": true,
        "formats": [
          "Full name: first_names \"nickname\" last_names name_suffix",
          "Full name sorted by last name: last_names name_suffix, first_names \"nickname\"",
          "First name & last name: first_names last_names name_suffix",
          "Last name(s), first name(s): last_names name_suffix, first_names",
          "Last name only: last_names",
          "First name only: first_names (or last_names if first_names empty for mononyms)"
        ],
        "anonymous_handling": "All formats show 'Anonymous {collaborator_id}' if anonymous=True"
      },
      
      "searchable_name_terms": {
        "purpose": "Enable comprehensive name searching",
        "computation": "Set of all words from first_names, last_names, name_suffix, nickname, other_names",
        "display_location": "Searchable Name Terms card on CollaboratorDetail page",
        "anonymous_handling": "Shows 'None' if anonymous=True"
      },
      
      "confidence_level": "high",
      "status": "active"
    },
    
    "dialect_decommissioning": {
      "decision_id": "collab_003",
      "content": "Complete removal of Dialect and DialectInstance models, replaced with direct Languoid M2M relationships",
      "added_date": "2025-11-08",
      "motivation": [
        "Dialect/DialectInstance was overcomplicated legacy design",
        "Languoid model now handles both languages and dialects hierarchically",
        "Custom through model (DialectInstance) with required modified_by field made M2M operations complex",
        "Migrating to Django's default M2M tables simplifies codebase significantly"
      ],
      
      "removed_models": {
        "Dialect": {
          "description": "Legacy model for dialect names",
          "deletion_date": "2025-11-08",
          "reason": "Dialects now represented as Languoid objects with level_glottolog='dialect'"
        },
        "DialectInstance": {
          "description": "Custom through model for M2M language relationships",
          "deletion_date": "2025-11-08",
          "fields_removed": [
            "document FK",
            "item FK", 
            "collaborator_native FK",
            "collaborator_other FK",
            "language FK",
            "name M2M (to Dialect)",
            "modified_by CharField",
            "added/updated timestamps"
          ],
          "reason": "Replaced with Django's auto-generated M2M through tables"
        }
      },
      
      "migration_strategy": {
        "migration_file": "0102_decommission_dialect_models.py",
        "operations_sequence": [
          "1. RemoveField: Remove old M2M fields (with through='DialectInstance')",
          "2. AddField: Add new M2M fields (without through, Django creates default tables)",
          "3. RunPython: Migrate relationship data from DialectInstance to new through tables",
          "4. DeleteModel: Drop Dialect and DialectInstance tables"
        ],
        "data_preservation": {
          "relationships_migrated": "All M2M relationships (Collaborator↔Languoid, Item↔Languoid, Document↔Languoid)",
          "metadata_discarded": "modified_by, timestamps, Dialect name associations (deprecated)"
        },
        "rollback_support": "None - one-way migration, restore from backup if needed"
      },
      
      "model_changes": {
        "Collaborator": {
          "before": "native_languages = M2M(Languoid, through='DialectInstance', through_fields=('collaborator_native', 'language'))",
          "after": "native_languages = M2M(Languoid) # Django creates metadata_collaborator_native_languages table",
          "same_for": "other_languages field"
        },
        "Item": {
          "before": "language = M2M(Languoid, through='DialectInstance', through_fields=('item', 'language'))",
          "after": "language = M2M(Languoid) # Django creates metadata_item_language table"
        },
        "Document": {
          "before": "language = M2M(Languoid, through='DialectInstance', through_fields=('document', 'language'))",
          "after": "language = M2M(Languoid) # Django creates metadata_document_language table"
        }
      },
      
      "serializer_simplification": {
        "before": {
          "complexity": "Manual DialectInstance.objects.create() with modified_by tracking",
          "signal_triggering": "Manual m2m_changed.send() calls",
          "code_lines": "~120 lines of complex through model management"
        },
        "after": {
          "simplicity": "Simple .set() method on M2M manager",
          "signal_triggering": "Automatic by Django",
          "code_lines": "~10 lines total",
          "code_example": "instance.native_languages.set(native_languages_ids)"
        },
        "benefit": "~110 lines removed, much cleaner and more maintainable"
      },
      
      "legacy_view_handling": {
        "problem": "Old Django template views still referenced DialectInstance",
        "solution": "Stub classes in views.py that provide no-op implementations",
        "stub_classes": {
          "DialectInstanceStub": "Returns empty results for .objects.filter(), (None, False) for .get_or_create()",
          "DialectStub": "Returns empty results for .objects.filter()"
        },
        "rationale": [
          "Legacy views not used (React-only frontend)",
          "Stub prevents crashes without requiring deletion of hundreds of lines",
          "Clearly documented as deprecated for future cleanup"
        ],
        "location": "app/metadata/views.py lines 30-93"
      },
      
      "confidence_level": "high",
      "status": "active",
      "lines_of_code_removed": "~255 lines (models, serializers, signals, admin, forms)"
    },
    
    "language_relationship_signals": {
      "decision_id": "collab_004",
      "content": "M2M signals that automatically add parent languages when dialects are selected",
      "added_date": "2025-11-08",
      "purpose": "Maintain data integrity - if a dialect is selected, its parent language must also be present",
      
      "implementation": {
        "collaborator_signal": {
          "name": "auto_add_parent_language_for_collaborator_dialects",
          "file": "app/metadata/signals.py",
          "receivers": [
            "Collaborator.native_languages.through (m2m_changed)",
            "Collaborator.other_languages.through (m2m_changed)"
          ],
          "triggers": ["post_add", "post_clear", "post_remove"],
          "logic": [
            "1. Determine which field (native_languages vs other_languages) based on through table name",
            "2. Get ALL current languoids in the field (not just newly added)",
            "3. Find all dialects and identify their parent languages",
            "4. Check if parent languages are already in the field",
            "5. Add missing parent languages using .add()",
            "6. Log auto-add actions for auditability"
          ],
          "field_detection": "Inspects sender._meta.db_table name to determine native vs other",
          "prevents_wrong_field_addition": "Queries actual DialectInstance records to identify correct field"
        },
        "item_signal": {
          "name": "auto_add_parent_language_for_item_dialects",
          "file": "app/metadata/signals.py",
          "receiver": "Item.language.through (m2m_changed)",
          "triggers": ["post_add", "post_clear", "post_remove"],
          "logic": "Same as collaborator signal but for single language field"
        }
      },
      
      "trigger_scenarios": {
        "adding_dialect": "Staff member adds Northern Pomo → Signal adds Pomo",
        "removing_parent_but_keeping_dialect": "Staff member removes Pomo but keeps Northern Pomo → Signal re-adds Pomo",
        "set_operation": ".set([dialect_ids]) → Triggers post_clear then post_add → Signal ensures parents present",
        "multiple_actions": "Fires on post_add, post_clear, post_remove to ensure consistency after any change"
      },
      
      "consistency_approach": {
        "old_implementation": "Only checked newly added languoids in pk_set",
        "new_implementation": "Checks ALL current languoids after any change",
        "benefit": "Ensures consistency regardless of operation sequence",
        "example": "If staff member deletes parent but keeps dialects, signal re-adds parent on post_remove"
      },
      
      "user_experience": {
        "frontend_help_text": "Displayed when editing language fields",
        "message": "You can add languages and dialects directly. If you add a dialect, its parent language will automatically be added.",
        "auto_add_visibility": "Parent language appears immediately after save (via useEffect watching value changes)",
        "no_refresh_needed": "EditableMultiRelationshipField re-renders when value prop changes"
      },
      
      "confidence_level": "high",
      "status": "active"
    },
    
    "react_frontend_enhancements": {
      "decision_id": "collab_005",
      "content": "Production-ready CollaboratorDetail and CollaboratorList pages with advanced features",
      "added_date": "2025-11-08",
      
      "collaborator_detail_page": {
        "location": "frontend/src/components/collaborators/CollaboratorDetail.tsx",
        "enhancements": [
          {
            "feature": "Full Name Field",
            "implementation": "Read-only with computed label",
            "display": "Shows full_name at top, cannot be edited directly",
            "label": "Full Name (computed from name fields below)"
          },
          {
            "feature": "Collaborator ID Validation",
            "implementation": "Real-time uniqueness check with debouncing",
            "validation": [
              "Numeric-only check (rejects '480000sw')",
              "Uniqueness check via API (allows current object's own ID)",
              "Exact match filter on backend (not substring)"
            ],
            "warning_message": "This value is for internal software bookkeeping. You can edit it without breaking things, but it has no inherent value to organize these IDs."
          },
          {
            "feature": "Anonymous Field",
            "implementation": "Three-state boolean with proper display",
            "fix": "Added displayEmpty and renderValue to show 'Not specified' correctly in closed dropdown"
          },
          {
            "feature": "Date Fields",
            "implementation": "High-fidelity feedback matching Item detail page",
            "components": [
              "DateInterpretationFeedback - real-time parsing feedback",
              "DateFormatHelp - static format reference",
              "Both replicated from ItemDetail.tsx with exact fidelity"
            ]
          },
          {
            "feature": "Display Name Variations Card",
            "location": "Right column, after Dates card",
            "formats": [
              "Full Name",
              "Full Name Sorted by Last Name",
              "First Name(s) & Last Name(s)",
              "Last Name(s), First Name(s)",
              "Last Name(s) only",
              "First Name(s) only"
            ],
            "anonymous_handling": "All show 'Anonymous {collaborator_id}' if anonymous"
          },
          {
            "feature": "Searchable Name Terms Card",
            "location": "Right column, below Display Name Variations",
            "content": "Computed set of all words from name fields",
            "anonymous_handling": "Shows 'None' if anonymous"
          },
          {
            "feature": "Page Title",
            "value": "full_name (computed from component fields)",
            "anonymous_handling": "Shows 'Anonymous {collaborator_id}' if anonymous"
          },
          {
            "feature": "Language Editing (native_languages & other_languages)",
            "component": "EditableMultiRelationshipField",
            "capabilities": [
              "In-place editing with autocomplete search",
              "Hierarchical chip display (dialects grouped with parents)",
              "Visual differentiation (languages=primary blue, dialects=default gray)",
              "Auto-add parent languages when dialect selected",
              "Help text explaining auto-add behavior",
              "Line breaks between language groups for clarity"
            ],
            "filter": "level_glottolog__in: 'language,dialect' (excludes families)"
          },
          {
            "feature": "Overview Card Languages Display",
            "implementation": "Uses native_languages and other_languages Languoid objects (not deprecated string arrays)",
            "organization": "Hierarchical with organizeLanguoidsForDisplay() helper",
            "visual": "Languages in primary blue, dialects grouped with parents"
          }
        ],
        "status": "production_ready",
        "confidence_level": "high"
      },
      
      "collaborator_list_page": {
        "location": "frontend/src/components/collaborators/CollaboratorsList.tsx",
        "enhancements": [
          {
            "feature": "Debounced Filtering",
            "implementation": "lodash.debounce with 500ms delay",
            "state_separation": "filters (staff input) vs activeFilters (API calls)",
            "benefit": "No more focus loss or page reloads during typing"
          },
          {
            "feature": "Auto-Filtering UI",
            "change": "Removed 'Search' button (filters apply automatically)",
            "added": "'Searching...' indicator and active filter count chip",
            "user_experience": "Clear feedback that filters are applying"
          },
          {
            "feature": "Anonymous Status Filter",
            "type": "Select dropdown",
            "options": ["Any", "Yes", "No", "Not Specified"],
            "backend": "BooleanFilter with isnull support for 'Not Specified'"
          },
          {
            "feature": "Empty Value Filters",
            "pattern": "Buttons like 'First Name(s): empty', 'Nickname: empty'",
            "backend_logic": {
              "CharField/TextField": "Q(field__isnull=True) | Q(field='')",
              "ArrayField": "Q(field__isnull=True) | Q(field=[]) | Q(field=[''])",
              "M2M": "Uses Django's isnull lookup directly (works for M2M)"
            },
            "included_fields": [
              "First Name(s)",
              "Nickname",
              "Suffix",
              "Other Names",
              "Tribal Affiliations",
              "Native languages",
              "Other languages",
              "Birthdate",
              "Deathdate"
            ],
            "excluded_fields": "Calculated fields like full_name",
            "backend_file": "app/internal_api/views.py CollaboratorFilter",
            "custom_filters": "Created custom filter methods for proper NULL vs empty string handling"
          }
        ],
        "performance": {
          "initial_load_fix": "Added initialLoadComplete state",
          "benefit": "Prevents full-page loading screen from unmounting filter fields on subsequent searches",
          "focus_retention": "Filter fields remain focused during typing"
        },
        "status": "production_ready",
        "confidence_level": "high"
      },
      
      "reusable_component_enhancements": {
        "EditableMultiRelationshipField": {
          "location": "frontend/src/components/common/EditableMultiRelationshipField.tsx",
          "major_fixes": [
            {
              "issue": "Wrong chip removed when clicking X in edit mode",
              "root_cause": "Visual order (hierarchical sorted) didn't match data order (unsorted)",
              "solution": "Use actualIndex = tagValue.findIndex(t => t.id === item.option.id) instead of incrementing counter",
              "benefit": "Clicking X on a chip removes the correct languoid"
            },
            {
              "issue": "Selected chips disappeared when entering edit mode",
              "root_cause": "Stringifying full Languoid objects instead of just IDs",
              "solution": "Extract IDs before stringifying in handleStartEditing",
              "optimization": "Use existing full objects from value prop if available (avoid unnecessary API call)"
            },
            {
              "issue": "Parent language didn't appear after auto-add until refresh",
              "root_cause": "useEffect not re-triggering when value prop changed",
              "solution": "Modified useEffect to compare IDs and update selectedOptions when value changes"
            }
          ],
          "hierarchical_display": {
            "helper_function": "organizeLanguoidChips(languoids)",
            "logic": [
              "1. Separate languages and dialects",
              "2. Sort languages alphabetically",
              "3. For each language, append its dialects",
              "4. Append orphan dialects at end"
            ],
            "visual_rendering": {
              "read_mode": "Line breaks between language groups, dialects inline with parent",
              "edit_mode": "Same hierarchical organization maintained in chip array",
              "styling": "Languages=primary blue, dialects=default gray, no italics/dashed borders"
            }
          },
          "type_flexibility": {
            "value_prop": "number[] | Array<{ id: number; [key: string]: any }>",
            "benefit": "Accepts both ID arrays and full object arrays",
            "runtime_handling": "Detects type and handles appropriately"
          }
        },
        "EditableBooleanField": {
          "location": "frontend/src/components/common/EditableBooleanField.tsx",
          "fix": "Added displayEmpty and renderValue to Select component",
          "benefit": "Not specified' shows correctly in closed dropdown (was blank before)"
        },
        "DateInterpretationFeedback": {
          "location": "frontend/src/components/common/DateInterpretationFeedback.tsx",
          "purpose": "Real-time feedback on date input parsing",
          "replicated_to": "CollaboratorDetail from ItemDetail with high fidelity"
        },
        "DateFormatHelp": {
          "location": "frontend/src/components/common/DateFormatHelp.tsx",
          "purpose": "Static date format reference",
          "consistency": "Matched ItemDetail version exactly for CollaboratorDetail"
        }
      },
      
      "confidence_level": "high",
      "status": "active"
    },
    
    "item_model_alignment": {
      "decision_id": "collab_006",
      "content": "Applied language editing capabilities from Collaborator to Item model",
      "added_date": "2025-11-08",
      
      "changes": {
        "ItemDetail_page": {
          "location": "frontend/src/components/items/ItemDetail.tsx",
          "language_field": {
            "component": "EditableMultiRelationshipField",
            "replaces": "Read-only language_names display",
            "features": [
              "In-place editing with autocomplete",
              "Hierarchical display (dialects with parents)",
              "Auto-add parent languages when dialect selected",
              "Help text explaining behavior",
              "Styled chips (languages=primary, dialects=default)"
            ],
            "card_title": "Changed from 'Languages' to 'Languages and Dialects'",
            "filter": "level_glottolog__in: 'language,dialect'"
          }
        },
        "Item_model_M2M": {
          "before": "language = M2M(Languoid, through='DialectInstance')",
          "after": "language = M2M(Languoid) # Django's default through table",
          "signal": "auto_add_parent_language_for_item_dialects (same logic as Collaborator)"
        },
        "InternalItemSerializer": {
          "changes": [
            "language changed from PrimaryKeyRelatedField to SerializerMethodField",
            "get_language() returns full Languoid objects for read",
            "custom update() method handles IDs for write",
            "Uses .set() method (simplified from manual DialectInstance creation)"
          ]
        },
        "ItemMutationData_type": {
          "purpose": "Allow language field to be number[] for create/update but Languoid[] on read",
          "type_definition": "interface ItemMutationData extends Partial<Omit<Item, 'language'>> { language?: number[] | Languoid[]; }",
          "usage": "itemsAPI.create(), update(), and patch() methods",
          "benefit": "Resolves TypeScript compilation errors in ItemCreate.tsx"
        }
      },
      
      "consistency": {
        "principle": "Same patterns across Collaborator and Item for language editing",
        "shared_components": "EditableMultiRelationshipField, organizeLanguoidChips helper",
        "shared_signals": "Same auto-add parent language logic",
        "user_experience": "Consistent behavior across all models with language fields"
      },
      
      "confidence_level": "high",
      "status": "active"
    },
    
    "architectural_improvements": {
      "decision_id": "collab_007",
      "content": "Design principles and patterns established during this refactoring",
      "added_date": "2025-11-08",
      
      "design_for_end_state_first": {
        "principle": "When implementing multiple related features, design the final architecture first, then implement incrementally",
        "example": "Planned all Collaborator signals upfront, then implemented one by one",
        "benefit": "Cleaner code than implementing piecemeal and refactoring between each feature"
      },
      
      "signal_driven_computed_fields": {
        "principle": "All derived fields computed in pre_save signals for consistency and auditability",
        "location": "compute_collaborator_derived_fields in app/metadata/signals.py",
        "benefits": [
          "Single source of truth for derivation logic",
          "Always fires (unlike overriding save())",
          "Centralized and easy to test",
          "Logging and auditing capabilities"
        ],
        "fields_computed": "full_name, birthdate/deathdate standardization, slug, min/max dates"
      },
      
      "m2m_consistency_signals": {
        "principle": "Use m2m_changed signals to enforce data integrity rules on relationships",
        "triggers": "post_add, post_clear, post_remove (cover all change scenarios)",
        "strategy": "Check ALL current relationships after any change (not just delta)",
        "benefit": "Ensures consistency regardless of operation type (.add(), .set(), .remove())"
      },
      
      "stub_classes_for_deprecation": {
        "principle": "When removing widely-used classes, create stubs to prevent cascading failures",
        "use_case": "Legacy Django template views still referencing DialectInstance",
        "implementation": "Stub classes with no-op methods returning empty results",
        "benefit": "Prevents errors without requiring deletion of hundreds of lines",
        "documentation": "Clearly marked as deprecated with cleanup plan"
      },
      
      "type_flexibility_in_components": {
        "principle": "React components should handle multiple data formats gracefully",
        "example": "EditableMultiRelationshipField accepts number[] or full object arrays",
        "implementation": "Runtime type detection with appropriate handling",
        "benefit": "Works with API responses (full objects) and form submissions (IDs)"
      },
      
      "hierarchical_display_helpers": {
        "principle": "Complex display logic should be extracted to helper functions",
        "example": "organizeLanguoidChips() for hierarchical language/dialect display",
        "reuse": "Used in both read mode and edit mode, across multiple components",
        "benefit": "Consistent display logic, easier to test, single source of truth"
      },
      
      "confidence_level": "high",
      "status": "active"
    },
    
    "production_readiness": {
      "decision_id": "collab_008",
      "content": "Collaborator model and React pages ready for production deployment",
      "added_date": "2025-11-08",
      
      "backend_completeness": [
        "✅ Name field structure enforced with signal-based computation",
        "✅ Language relationships simplified (no more custom through models)",
        "✅ Signals ensure data integrity (auto-add parent languages, validate anonymous changes)",
        "✅ Date standardization automatic",
        "✅ Slug generation automatic",
        "✅ Migration successfully executed (Dialect/DialectInstance removed)"
      ],
      
      "frontend_completeness": [
        "✅ CollaboratorDetail page with all fields editable",
        "✅ Language relationship editing with hierarchical display",
        "✅ Display name variations for citations",
        "✅ Searchable name terms computed",
        "✅ Anonymous collaborator handling throughout",
        "✅ CollaboratorList page with advanced filtering",
        "✅ Empty value filters for comprehensive searching",
        "✅ Debounced filters with proper UX",
        "✅ All editable field components working correctly"
      ],
      
      "testing_completed": [
        "✅ Name field computation tested",
        "✅ Language auto-add parent tested",
        "✅ Chip removal in edit mode tested (correct languoid removed)",
        "✅ Parent re-add when removed tested",
        "✅ Anonymous flag display tested",
        "✅ Date field feedback tested",
        "✅ Empty value filters tested (NULL vs empty string handling)",
        "✅ Collaborator ID validation tested"
      ],
      
      "code_quality": [
        "✅ ~255 lines of complex code removed",
        "✅ No linter errors",
        "✅ TypeScript compilation successful",
        "✅ Signals well-documented with docstrings",
        "✅ Frontend components follow established patterns",
        "✅ Reusable components enhanced and stable"
      ],
      
      "next_steps": [
        "Document model ready for similar treatment if needed",
        "Consider removing legacy Django template views entirely",
        "Monitor production logs for any signal-related issues",
        "End-user testing and feedback collection"
      ],
      
      "confidence_level": "high",
      "status": "production_ready"
    }
  }
}

